#include <base/pecker.h>
#include "pecker_mcla.h"
#include <getopt.h>

#define DEAD_CODE 0
#define MCLA_TRAIN_HELP  \
    "Usage: %s [OPTION...] [STRING...]\n\n" \
    "    -h, --help                        display this help and exit\n"\
    "\n"\
    "    -s, --src-path FILE               set the src file path\n"\
    "    -d, --dst-path FILE               set the dst file path\n"\
    "\n"\
    "    -l, --height NUM                  set the output image height, def:512\n"\
    "    -w, --width NUM                   set the output image width, def:512\n"\
    "    -m, --img-data                    creat image train data\n"\
    "    -b, --bin2img                     convert binary files to images\n"\
    "    -p, --pe-data                     creat PE file structure train data\n"\
    "    -t, --train-data                  creat all PE and image train data\n"\
    "\n"

static char *progname;     /* used throughout */    
static mcla_t *g_mcla = NULL;
static int opt;
static struct option longopts[] = {
    {"help", 0, NULL, 'h'},
    {"src-path", 1, NULL, 's'},
    {"dst-path", 1, NULL, 'd'},
    {"height", 1, NULL, 'l'},
    {"width", 1, NULL, 'w'},
    {"img-data", 0, NULL, 'm'},
    {"bin2img", 0, NULL, 'b'},
    {"pe-data", 0, NULL, 'p'},
    {"train-data", 0, NULL, 't'},
    {0,0,0,0}
};

typedef enum
{
    TRAIN_DO_NOTHING = 0,          /* do nothing */
        
    TRAIN_CREAT_IMAGE_DATA,
    TRAIN_BIN_TO_IMAGE,
    TRAIN_CREAT_PE_DATA,
    TRAIN_CREAT_ALL_DATA,
    
} train_cmd_t;

void mcla_train_help(void);

int main(int argc, char **argv)
{
    int ret = 0;
    int helpinfo = 1;
    int cmd = TRAIN_DO_NOTHING;
    uint32_t img_height = 512;
    uint32_t img_width = 512;
    char *src = NULL;
    char *dst = NULL;
    char img_dst[1024];
    char pe_dst[1024];
    
    g_mcla = pecker_mcla_init();

    if ((progname = strrchr(argv[0], '/')) != NULL)
        progname++;
    else
        progname = argv[0];

    while((opt = getopt_long(argc, argv, "hmbpts:d:l:w:", longopts, NULL)) != -1)
    {
        switch(opt)
        {
            case 'm':
                cmd = TRAIN_CREAT_IMAGE_DATA;
                break;
            case 'b':
                cmd = TRAIN_BIN_TO_IMAGE;
                break;
            case 'p':
                cmd = TRAIN_CREAT_PE_DATA;
                break;
            case 't':
                cmd = TRAIN_CREAT_ALL_DATA;
                break;
            case 'l':
                img_height = atoi(optarg);
                break;
            case 'w':
                img_width = atoi(optarg);
                break;
            case 's':
                src = strdup(optarg);
                break;
            case 'd':
                dst = strdup(optarg);
                break;
            case 'h':
                helpinfo++;
                break;
            case '?':
                helpinfo++;
                break;
            default:
                helpinfo++;
                break;
        }
    }

    if(cmd == TRAIN_CREAT_IMAGE_DATA && src != NULL && dst != NULL)
    {
        helpinfo = 0;
        ret = pecker_mcla_creat_img_train_data(src, dst);
        if(0 == ret)
        {
            printf("The image train data is created in %s\n", dst);
        }
        else
        {
            fprintf(stderr, "Creat image train data error, retcode %d\n", ret);
        }
    }
    else if(cmd == TRAIN_BIN_TO_IMAGE && src != NULL && dst != NULL)
    {
        helpinfo = 0;
        ret = pecker_mcla_bin2img(src, dst, img_height, img_width);
        if(0 == ret)
        {
            printf("Convert %s into %s success\n", src, dst);
        }
        else
        {
            fprintf(stderr, "Convert %s into %s fail, retcode %d\n", src, dst, ret);
        }
    }
    else if(cmd == TRAIN_CREAT_PE_DATA && src != NULL && dst != NULL)
    {
        helpinfo = 0;
        ret = pecker_mcla_creat_pe_train_data(src, dst);
        if(0 == ret)
        {
            printf("The pe train data is created in %s\n", dst);
        }
        else
        {
            fprintf(stderr, "Creat pe train data error, retcode %d\n", ret);
        }
    }
    else if(cmd == TRAIN_CREAT_ALL_DATA && src != NULL && dst != NULL)
    {
        helpinfo = 0;
        sprintf(img_dst, "%s.img", dst);
        sprintf(pe_dst, "%s.pe", dst);
        ret = pecker_mcla_creat_all_train_data(src, img_dst, pe_dst);
        if(0 == ret)
        {
            printf("The train data is created in %s and %s\n", img_dst, pe_dst);
        }
        else
        {
            fprintf(stderr, "Creat train data error, retcode %d\n", ret);
        }
    }
    else
    {
        helpinfo++;
    }
    
    if(helpinfo)
    {
        mcla_train_help();
    }
        
    pecker_mcla_free(g_mcla);
    return ret;
}

void mcla_train_help(void)
{
    (void)fprintf(stderr, MCLA_TRAIN_HELP, progname);
    exit(1);
}

