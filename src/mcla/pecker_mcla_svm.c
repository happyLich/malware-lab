#include <base/pecker.h>
#include <base/pecker_log.h>
#include <libsvm/svm.h>

#include "pecker_mcla_svm.h"
#include "pecker_mcla_util.h"

svm_model_s *pecker_svm_init()
{
    svm_model_s *svm_m = NULL;
    svm_m = (svm_model_s *)calloc(1, sizeof(svm_model_s));
    if(NULL == svm_m)
        goto error;
        
    return svm_m;

error:
    pecker_svm_free(svm_m);
    return NULL;
}

int pecker_svm_free(svm_model_s *svm_m)
{
    if(svm_m)
    {
        PECKER_MCLA_FREE(svm_m->svm_nd);
        svm_free_and_destroy_model(&svm_m->svm);
    }
    PECKER_MCLA_FREE(svm_m);
    return PECKER_MCLA_OK;
}

int pecker_svm_load_model(svm_model_s *svm_m, char *path)
{
    int ret = PECKER_MCLA_OK;

    if(NULL == svm_m)
        return PECKER_MCLA_NULL_POINTER;

    if(svm_m->svm)
    {
        svm_free_and_destroy_model(&svm_m->svm);
        svm_m->svm = NULL;
    }

    svm_m->svm = svm_load_model(path);
    if(svm_m->svm == NULL)
        return PECKER_MCLA_SVM_LOAD_MODEL_FAIL;
        
    return ret;
}

int pecker_svm_predict(svm_model_s *svm_m)
{
    int ret = PECKER_MCLA_OK;

    if(NULL == svm_m || NULL == svm_m->svm || NULL == svm_m->svm_nd)
        return PECKER_MCLA_NULL_POINTER;

    svm_m->report = svm_predict(svm_m->svm, svm_m->svm_nd);
    return ret;
}

